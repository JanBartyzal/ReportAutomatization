# Task: Comprehensive Backend Code Review & Refactoring

**Type:** Maintenance / Tech Debt
**Target Component:** `backend/` (FastAPI)
**Reference Standard:** `dod_criteria.md`

---

## 1. Objective
Perform a deep-dive code review and subsequent refactoring of the current Python FastAPI backend. The goal is to establish a production-ready architecture, eliminate security risks, and ensure the codebase is fully documented.

## 2. Scope of Review

### A. Architecture & Pattern enforcement
- **FastAPI Best Practices:** Verify usage of `APIRouter`, Dependency Injection (`Depends`), and Pydantic models.
- **Service Layer Pattern:** Separation of concerns (Business Logic vs. HTTP Transport).
- **Configuration:** Usage of Pydantic `BaseSettings` for environment variables.

### B. Security (Critical)
- **Auth Integration:** Confirm `fastapi-azure-auth` guards all private endpoints.
- **Data Safety:** SQL Injection prevention (ORM usage), Secret management.

### C. Code Quality (DoD Alignment)
- **Typing:** Strict Python typing (`mypy` compatible).
- **Error Handling:** Structured JSON error responses (no raw 500 tracebacks).
- **Async Safety:** No blocking code in async endpoints.

---

## 3. Review Process Instructions (For the AI Agent)

**Step 1: Analysis & Report**
Analyze the code. Output a table: | Severity | File | Issue | Recommendation |.

**Step 2: Refactoring Plan**
Propose the new directory structure (e.g., `app/routers`, `app/services`).

**Step 3: Execution & Documentation**
Rewrite the code module by module. **Crucially, perform the Documentation tasks defined in Section 5 continuously.**

---

## 4. Specific Checks for PPTX-AI Logic
- **Image Hashing:** Validate SHA-256 caching logic.
- **Resource Management:** Check file handle closing.
- **AI Fallback Logic:** Verify priority: Native -> OCR -> AI Vision.

---

## 5. Documentation Deliverables (MANDATORY)

As part of this refactoring, you MUST generate/update the following files in the `docs/` folder:

### A. Update Project Status
- **File:** `project_status.md` (root)
- **Action:**
    - Update the **"Current Features"** section to reflect the new robust architecture.
    - If any "Backlog" items were partially solved by refactoring, move them to "Current".
    - Update **"Key Metrics"** if performance improvements are expected.

### B. Technical Documentation
- **File:** `docs/technical/backend_structure.md`
- **Action:** Create a new document describing the refactored architecture.
    - Include a file tree structure explanation.
    - Include a Mermaid diagram of the Request/Response flow through the new layers (Router -> Service -> DB) plus code of this diagram.

### C. API Documentation
- **File:** `docs/api/openapi_summary.md`
- **Action:** Provide a summary of available endpoints and their security scopes. (Note: The actual OpenAPI json is generated by FastAPI, but we need a human-readable summary here).

**Definition of Done for this Task:**
The task is ONLY complete when the code is refactored AND `project_status.md` is updated AND `backend_structure.md` is created.